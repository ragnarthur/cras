{% extends "base.html" %}

{% block title %}Editar Gestante - CRAS App{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4" style="font-size: 2rem; font-weight: bold; letter-spacing: 0.05rem;">Editar Gestante</h2>

    <form action="{{ url_for('editar_gestante', gestante_id=gestante['id']) }}" method="POST" class="needs-validation" novalidate>
        <!-- Box para informações pessoais da gestante -->
        <div class="card p-4 mb-4">
            <h5 class="card-title" style="font-size: 1.5rem; font-weight: bold; color: #0d6efd;">Informações Pessoais</h5>
            <div class="row">
                <!-- Nome -->
                <div class="col-md-6 mb-3">
                    <label for="nome" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Nome:</label>
                    <input type="text" class="form-control form-control-lg" id="nome" name="nome" value="{{ gestante['nome'] }}" required style="text-transform: uppercase;">
                    <div class="invalid-feedback" style="font-size: 1.1rem;">Por favor, insira o nome.</div>
                </div>

                <!-- CPF -->
                <div class="col-md-6 mb-3">
                    <label for="cpf" class="form-label" style="font-size: 1.2rem; font-weight: bold;">CPF:</label>
                    <input type="text" class="form-control form-control-lg" id="cpf" name="cpf" value="{{ gestante['cpf'] }}" placeholder="CPF" maxlength="14" required>
                    <div class="invalid-feedback" style="font-size: 1.1rem;">Por favor, insira o CPF.</div>
                </div>

                <!-- RG -->
                <div class="col-md-6 mb-3">
                    <label for="rg_gestante" class="form-label" style="font-size: 1.2rem; font-weight: bold;">RG:</label>
                    <input type="text" class="form-control form-control-lg" id="rg_gestante" name="rg" value="{{ gestante['rg'] }}" placeholder="RG" maxlength="12" required>
                    <div class="invalid-feedback" style="font-size: 1.1rem;">Por favor, insira o RG.</div>
                </div>

                <!-- Data de Nascimento -->
                <div class="col-md-6 mb-3">
                    <label for="data_nascimento" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Data de Nascimento:</label>
                    <input type="date" class="form-control form-control-lg" id="data_nascimento" name="data_nascimento" value="{{ gestante['data_nascimento'] }}" required>
                    <div class="invalid-feedback" style="font-size: 1.1rem;">Por favor, insira a data de nascimento.</div>
                </div>

                <!-- Data Prevista para Parto -->
                <div class="col-md-6 mb-3">
                    <label for="data_parto" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Data Prevista para Parto:</label>
                    <input type="date" class="form-control form-control-lg" id="data_parto" name="data_parto" value="{{ gestante['data_parto'] }}" required>
                    <div class="invalid-feedback" style="font-size: 1.1rem;">Por favor, insira a data prevista para parto.</div>
                </div>

                <!-- Telefone -->
                <div class="col-md-6 mb-3">
                    <label for="telefone" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Telefone:</label>
                    <input type="tel" class="form-control form-control-lg" id="telefone" name="telefone" value="{{ gestante['telefone'] }}" required>
                </div>
            </div>
        </div>

        <!-- Endereço -->
        <div class="card p-4 mb-4">
            <h5 class="card-title" style="font-size: 1.5rem; font-weight: bold; color: #0d6efd;">Endereço</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="rua" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Rua:</label>
                    <input type="text" class="form-control form-control-lg" id="rua" name="rua" value="{{ gestante['endereco'].split(', ')[0] if gestante['endereco'] else '' }}" required style="text-transform: uppercase;">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="numero" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Número:</label>
                    <input type="text" class="form-control form-control-lg" id="numero" name="numero" value="{{ gestante['endereco'].split(', ')[1] if gestante['endereco'] else '' }}" required style="text-transform: uppercase;">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="bairro" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Bairro:</label>
                    <input type="text" class="form-control form-control-lg" id="bairro" name="bairro" value="{{ gestante['endereco'].split(', ')[2] if gestante['endereco'] else '' }}" required style="text-transform: uppercase;">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="cidade" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Cidade:</label>
                    <input type="text" class="form-control form-control-lg" id="cidade" name="cidade" value="{{ gestante['endereco'].split(', ')[3] if gestante['endereco'] else '' }}" required style="text-transform: uppercase;">
                </div>
            </div>
        </div>

        <!-- Bolsa Família -->
        <div class="mb-4">
            <label class="form-label" style="font-size: 1.2rem; font-weight: bold;">Possui Bolsa Família?</label><br>
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" id="bolsa_sim" name="bolsa_familia" value="sim" {% if gestante['bolsa_familia'] == 'sim' %}checked{% endif %}>
                <label class="form-check-label" for="bolsa_sim" style="font-size: 1.2rem;">Sim</label>
            </div>
            <div class="form-check form-check-inline">
                <input type="radio" class="form-check-input" id="bolsa_nao" name="bolsa_familia" value="nao" {% if gestante['bolsa_familia'] == 'nao' %}checked{% endif %}>
                <label class="form-check-label" for="bolsa_nao" style="font-size: 1.2rem;">Não</label>
            </div>
        </div>

        <!-- Última data de retirada da cesta básica -->
        <div class="mb-4">
            <label for="data_cesta" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Última data de retirada da cesta básica:</label>
            <input type="date" class="form-control form-control-lg" id="data_cesta" name="data_cesta" value="{{ gestante['data_cesta'] }}">
            <div class="invalid-feedback" style="font-size: 1.1rem;">Por favor, insira a data de retirada da cesta básica.</div>
        </div>

        <!-- Switch para adicionar filho -->
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="adicionar_filho_switch" name="adicionar_filho">
            <label class="form-check-label" for="adicionar_filho_switch"
            <label class="form-check-label" for="adicionar_filho_switch" style="font-size: 1.2rem;">Adicionar filho</label>
        </div>

        <!-- Formulário dinâmico de filho -->
        <div id="filho_form_card" class="card p-3 mb-4" style="display: none;">
            <h5 class="card-title" style="font-size: 1.3rem;">Informações do Filho</h5>
            <div class="mb-3">
                <label for="nome_filho" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Nome do Filho</label>
                <input type="text" class="form-control form-control-lg" id="nome_filho" name="nome_filho" required style="text-transform: uppercase;">
            </div>
            <div class="mb-3">
                <label for="cpf_filho" class="form-label" style="font-size: 1.2rem; font-weight: bold;">CPF do Filho</label>
                <input type="text" class="form-control form-control-lg" id="cpf_filho" name="cpf_filho" maxlength="14" required>
            </div>
            <div class="mb-3">
                <label for="rg_filho" class="form-label" style="font-size: 1.2rem; font-weight: bold;">RG do Filho</label>
                <input type="text" class="form-control form-control-lg" id="rg_filho" name="rg_filho" maxlength="12" required>
            </div>
            <div class="mb-3">
                <label for="data_nascimento_filho" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Data de Nascimento do Filho</label>
                <input type="date" class="form-control form-control-lg" id="data_nascimento_filho" name="data_nascimento_filho" required>
            </div>
        </div>

        <!-- Switch para adicionar cônjuge -->
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="adicionar_conjuge_switch" name="adicionar_conjuge">
            <label class="form-check-label" for="adicionar_conjuge_switch" style="font-size: 1.2rem;">Adicionar cônjuge</label>
        </div>

        <!-- Formulário dinâmico de cônjuge -->
        <div id="conjuge_form_card" class="card p-3 mb-4" style="display: none;">
            <h5 class="card-title" style="font-size: 1.3rem;">Informações do Cônjuge</h5>
            <div class="mb-3">
                <label for="nome_conjuge" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Nome do Cônjuge</label>
                <input type="text" class="form-control form-control-lg" id="nome_conjuge" name="nome_conjuge" required style="text-transform: uppercase;">
            </div>
            <div class="mb-3">
                <label for="cpf_conjuge" class="form-label" style="font-size: 1.2rem; font-weight: bold;">CPF do Cônjuge</label>
                <input type="text" class="form-control form-control-lg" id="cpf_conjuge" name="cpf_conjuge" maxlength="14" required>
            </div>
            <div class="mb-3">
                <label for="rg_conjuge" class="form-label" style="font-size: 1.2rem; font-weight: bold;">RG do Cônjuge</label>
                <input type="text" class="form-control form-control-lg" id="rg_conjuge" name="rg_conjuge" maxlength="12" required>
            </div>
            <div class="mb-3">
                <label for="data_nascimento_conjuge" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Data de Nascimento do Cônjuge</label>
                <input type="date" class="form-control form-control-lg" id="data_nascimento_conjuge" name="data_nascimento_conjuge" required>
            </div>
        </div>

        <!-- Observações anteriores -->
        <div class="mb-4">
            <label class="form-label" style="font-size: 1.2rem; font-weight: bold;">Observações Anteriores:</label>
            {% if observacoes %}
            <div class="card shadow-sm border-secondary">
                <div class="card-body p-3">
                    <ul class="list-group list-group-flush">
                        {% for obs in observacoes %}
                        <li class="list-group-item d-flex justify-content-between align-items-start border-0">
                            <div class="ms-2 me-auto">
                                <span class="badge bg-primary rounded-pill">{{ obs.data_observacao.strftime('%d/%m/%Y') }}</span>
                                <div class="fw-bold mt-1">{{ obs.observacao }}</div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% else %}
            <p class="text-muted" style="font-size: 1.1rem;">Sem observações anteriores.</p>
            {% endif %}
        </div>

        <!-- Campo para adicionar nova observação -->
        <div class="mb-4">
            <label for="nova_observacao" class="form-label" style="font-size: 1.2rem; font-weight: bold;">Adicionar Nova Observação:</label>
            <textarea class="form-control form-control-lg shadow-sm border-secondary" id="nova_observacao" name="nova_observacao" placeholder="Insira uma nova observação" rows="4" style="text-transform: uppercase;"></textarea>
        </div>

        <!-- Botão de envio -->
        <button type="submit" class="btn btn-primary btn-lg w-100 mb-4">SALVAR ALTERAÇÕES</button>
    </form>

    <!-- Box unificado para edição de filhos e cônjuge -->
    <div class="card card-edit">
        <h4 class="card-title-edit" style="font-size: 1.5rem; font-weight: bold;">Editar Informações Familiares</h4>

        <!-- Filhos -->
        {% if filhos %}
        <div class="mb-3">
            <h5 class="card-title-edit" style="font-size: 1.3rem; font-weight: bold;">Filhos</h5>
            <ul class="list-group">
                {% for filho in filhos %}
                <li class="list-group-item">
                    <span><strong>{{ filho['nome'] }}</strong> - {{ filho['idade'] }} ANOS</span>
                    <br>
                    <a href="{{ url_for('editar_filho', filho_id=filho['id']) }}" class="btn btn-edit mt-2">EDITAR FILHO</a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <!-- Cônjuge -->
        {% if conjuge %}
        <div class="mb-3">
            <h5 class="card-title-edit" style="font-size: 1.3rem; font-weight: bold;">Cônjuge</h5>
            <p><strong>{{ conjuge['nome'] }}</strong></p>
            <a href="{{ url_for('editar_conjuge', usuario_id=gestante['id']) }}" class="btn btn-edit">EDITAR CÔNJUGE</a>
        </div>
        {% endif %}
    </div>

</div>

<script>
    // Máscara para CPF: 111.222.333-44
    function aplicarMascaraCPF(cpf) {
        cpf = cpf.replace(/\D/g, ''); // Remove todos os caracteres que não são dígitos
        if (cpf.length > 11) cpf = cpf.substring(0, 11); // Limita a 11 dígitos numéricos
        cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
        cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
        cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        return cpf;
    }

    // Máscara para RG: 11.222.333 (máximo de 8 dígitos, ignorando os pontos)
    function aplicarMascaraRG(rg) {
        rg = rg.replace(/\D/g, ''); // Remove todos os caracteres que não são dígitos
        rg = rg.substring(0, 8); // Limita a 8 dígitos numéricos (somente números)
        if (rg.length > 2) rg = rg.replace(/(\d{2})(\d)/, '$1.$2'); // Adiciona o primeiro ponto após 2 dígitos
        if (rg.length > 5) rg = rg.replace(/(\d{3})(\d)/, '$1.$2'); // Adiciona o segundo ponto após 5 dígitos
        return rg;
    }

    // Aplicando máscaras ao digitar nos campos de CPF e RG da gestante
    document.getElementById('cpf').addEventListener('input', function() {
        this.value = aplicarMascaraCPF(this.value);
    });

    document.getElementById('rg_gestante').addEventListener('input', function() {
        this.value = aplicarMascaraRG(this.value); // Aplica a máscara de RG no campo de RG da gestante
    });

    // Aplicando máscaras nos campos de filho e cônjuge
    document.getElementById('cpf_filho').addEventListener('input', function() {
        this.value = aplicarMascaraCPF(this.value);
    });

    document.getElementById('rg_filho').addEventListener('input', function() {
        this.value = aplicarMascaraRG(this.value);
    });

    document.getElementById('cpf_conjuge').addEventListener('input', function() {
        this.value = aplicarMascaraCPF(this.value);
    });

    document.getElementById('rg_conjuge').addEventListener('input', function() {
        this.value = aplicarMascaraRG(this.value);
    });

    // Exibição dos formulários dinâmicos
    document.getElementById('adicionar_filho_switch').addEventListener('change', function() {
        document.getElementById('filho_form_card').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('adicionar_conjuge_switch').addEventListener('change', function() {
        document.getElementById('conjuge_form_card').style.display = this.checked ? 'block' : 'none';
    });
</script>

{% endblock %}
